<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-localstorage/core-localstorage.html">



<polymer-element name="yahoo-currencies" attributes="list">
    <template>
        <core-ajax
            id='ajax' 
            url="http://api.max.pub/currencies"
            handleAs="json"
            on-core-response="{{convert}}">
        </core-ajax>
        
        <core-localstorage id='store' name="prices" value="{{prices}}" on-core-localstorage-load="{{storeLoad}}"></core-localstorage>
        
    </template>
    <script>
        Polymer({
            //http://rate-exchange.appspot.com/currency?from=EUR&to=THB
            //http://finance.yahoo.com/webservice/v1/symbols/allcurrencies/quote?format=json
            ready: function(){
//                console.log('yahoo');
//                this.$.ajax.go();
//                yah=this;
//                this.prices = {};
            },
            today:function(){
                var t = new Date();
                return t.getFullYear()+'-'+(t.getMonth()+1)+'-'+t.getDate();
            },
            storeLoad:function(){
//                console.log('store loaded',this.prices);
                if(!this.prices.date) return this.$.ajax.go();
                if(this.prices.date != this.today()) return this.$.ajax.go();
                this.list = this.prices.list;
                console.log('price cache',this.list);
            },
            convert:function(event,request,element){
//                console.log('yahoo-convert');
                var raw = request.response;
                var res = raw.list.resources;
                this.list = {};
                for(var i=0;i<res.length;i++){
                    var item = res[i].resource.fields;
//                    if(item.name.indexOf('/')===-1) continue;
                    var tmp = item.name.split('/');
                    if(tmp.length<2) continue;
                    var name = tmp[1];
                    var price = (item.price*1).toFixed(2);
                    this.list[name] = price;
//                    console.log('item',tmp[1],price);
                }
                this.prices = {date: this.today(), list:this.list};
                console.log('price update',this.list);
                this.$.store.save();
            }
        });
    </script>
</polymer-element>  



<polymer-element name="currency-converter" attributes="prices">
    <template>
        <style>
            *{
                font-family: sans-serif;
            }
            .iso{
                font-size: 20px;
/*                color: gray;*/
            }
            .country{
                color: silver;
                font-size:12px;
            }
            .currency{
                color: #333;
                font-size:16px;
            }
            .value{
                font-size: 20px;
                font-family: monospace;
                text-align: right;
            }
        </style>
        <core-ajax
            id='ajax' 
            auto
            url="Currencies.csv"
            handleAs="text"
            on-core-response="{{callback}}">
        </core-ajax>
        <table>
        <template repeat="{{item in list}}">
            <tr>
                <td>
                    <paper-icon-button icon='star'></paper-icon-button>
                </td>
                <td>
                    <img src='http://max.pub/flags/{{item.cc}}.png'/>
                </td>
<!--                <td class='iso'>{{item.iso}}</td>-->
                <td class='desc'>
                    <div class='currency'>{{item.name}}</div>
                    <div class='country'>{{item.country}}</div>
                </td>
                <td class='value'>{{prices[item.iso]}}</span>
            </tr>
        </template>
        </table>
    </template>
    
    <script>
        Polymer({
            //http://rate-exchange.appspot.com/currency?from=EUR&to=THB
            ready: function(){
            },
            callback:function(event,request,element){
                var raw = request.response;
                var lines = raw.split("\n");
                this.list = [];
                for(var i=0; i<lines.length;i++){
                    var tmp = lines[i].split(",");
                    this.list.push({
                        iso: tmp[0],
                        name: tmp[1],
                        cc: tmp[2],
                        country: tmp[3]
                    });
//                    var line = lines[i].replace(/\t/g, '  -- ');
//                    line = line.replace(/  /g, ' ');
//                    console.log(line);
//                    var tmp = line.split("  ");
//                    var iso = lines[i].substr(0,3);
//                    var tmp = lines[i].substr(4).split("\t");
//                    var name = tmp[0];
//                    var symbol = tmp[1];
//                    console.log('aaa:',tmp);
                }
                console.log(this.list);
            }
        });
    </script>
</polymer-element>
